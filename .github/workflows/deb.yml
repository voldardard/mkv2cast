name: Debian Package

on:
  release:
    types: [published]
  push:
    tags:
      - "v*"

permissions:
  contents: write
  pages: write
  id-token: write

jobs:
  build-deb:
    name: Build Debian Package
    runs-on: ubuntu-latest
    # Only run for patch releases (format X.Y.Z-N, not base versions like X.Y.Z)
    if: |
      (github.event_name == 'release' && !github.event.release.prerelease) ||
      (github.event_name != 'release' && startsWith(github.ref, 'refs/tags/v') && !contains(github.ref, '-beta') && !contains(github.ref, '-alpha') && !contains(github.ref, '-rc'))
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
      
      - name: Extract version from tag
        id: version
        run: |
          VERSION=${GITHUB_REF#refs/tags/v}
          # Only process patch releases (format X.Y.Z-N)
          if echo "$VERSION" | grep -qE '^[0-9]+\.[0-9]+\.[0-9]+-[0-9]+$$'; then
            echo "version=$VERSION" >> $GITHUB_OUTPUT
            echo "Building Debian package for patch release: $VERSION"
          else
            echo "Skipping base version (not a patch release): $VERSION"
            echo "version=" >> $GITHUB_OUTPUT
            exit 0
          fi
      
      - name: Check if patch release
        if: steps.version.outputs.version == ''
        run: |
          echo "Not a patch release, skipping Debian build"
          exit 0
      
      - name: Install build dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            build-essential \
            devscripts \
            debhelper \
            dh-python \
            python3-all \
            python3-build \
            python3-installer \
            python3-hatchling \
            fakeroot \
            dpkg-dev \
            apt-utils
      
      - name: Update debian/changelog version
        if: steps.version.outputs.version != ''
        run: |
          cd packaging/debian
          sed -i "1s/([^)]*)/(${{ steps.version.outputs.version }}-1)/" changelog
          cat changelog
      
      - name: Prepare source directory
        if: steps.version.outputs.version != ''
        run: |
          mkdir -p build-deb/mkv2cast-${{ steps.version.outputs.version }}
          cp -r src pyproject.toml README.md LICENSE CHANGELOG.md man completions systemd \
            build-deb/mkv2cast-${{ steps.version.outputs.version }}/
          cp -r packaging/debian build-deb/mkv2cast-${{ steps.version.outputs.version }}/
      
      - name: Build Debian package
        if: steps.version.outputs.version != ''
        run: |
          cd build-deb/mkv2cast-${{ steps.version.outputs.version }}
          dpkg-buildpackage -us -uc -b
          ls -la ../
      
      - name: Upload Debian artifact
        uses: actions/upload-artifact@v4
        with:
          name: deb-packages
          path: build-deb/*.deb
      
      - name: Upload .deb to Release
        if: github.event_name == 'release'
        uses: softprops/action-gh-release@v1
        with:
          files: build-deb/*.deb
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  update-apt-repo:
    name: Update APT Repository
    runs-on: ubuntu-latest
    needs: build-deb
    if: needs.build-deb.result == 'success'
    
    steps:
      - name: Checkout main branch
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      
      - name: Create or checkout apt-repo branch
        run: |
          # Configure git
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Configure remote URL with token for authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Check if apt-repo branch exists remotely
          if git ls-remote --heads origin apt-repo | grep -q apt-repo; then
            echo "apt-repo branch exists, checking out..."
            git fetch origin apt-repo
            git checkout apt-repo
          else
            echo "apt-repo branch does not exist, creating it..."
            # Create orphan branch (no history)
            git checkout --orphan apt-repo
            # Remove all files from staging
            git rm -rf . || true
            # Create initial commit with README
            mkdir -p apt
            echo "# mkv2cast APT Repository" > apt/README.md
            git add apt/README.md
            git commit -m "Initial APT repository structure"
            # Push to create the branch remotely
            git push origin apt-repo
          fi
      
      - name: Install APT tools
        run: |
          sudo apt-get update
          sudo apt-get install -y dpkg-dev apt-utils gnupg
      
      - name: Check if GPG key is configured
        id: check_gpg
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
        run: |
          if [ -n "$GPG_PRIVATE_KEY" ]; then
            echo "gpg_configured=true" >> $GITHUB_OUTPUT
          else
            echo "gpg_configured=false" >> $GITHUB_OUTPUT
          fi
      
      - name: Import GPG key
        if: steps.check_gpg.outputs.gpg_configured == 'true'
        env:
          GPG_PRIVATE_KEY: ${{ secrets.GPG_PRIVATE_KEY }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE || '' }}
        run: |
          # Create GPG directory
          mkdir -p ~/.gnupg
          chmod 700 ~/.gnupg
          
          # Import private key
          echo "$GPG_PRIVATE_KEY" | gpg --batch --import
          
          # Get key ID
          KEY_ID=$(gpg --list-secret-keys --keyid-format LONG | grep -E "^(sec|SEC)" | head -1 | awk '{print $2}' | cut -d'/' -f2)
          echo "GPG_KEY_ID=$KEY_ID" >> $GITHUB_ENV
          
          # Export public key for distribution
          gpg --armor --export "$KEY_ID" > public-key.gpg
          echo "Public key exported to public-key.gpg"
          gpg --fingerprint "$KEY_ID"
      
      - name: Download Debian artifact
        uses: actions/download-artifact@v4
        with:
          name: deb-packages
          path: build-deb-artifacts

      - name: Stage .deb file
        run: |
          mkdir -p pool/main
          cp build-deb-artifacts/*.deb pool/main/
          ls -la pool/main/
      
      - name: Generate Packages index
        run: |
          mkdir -p dists/stable/main/binary-amd64
          mkdir -p dists/stable/main/binary-arm64
          mkdir -p dists/stable/main/binary-all
          
          # Generate Packages file
          cd pool/main
          dpkg-scanpackages --arch all . > ../../dists/stable/main/binary-all/Packages
          cp ../../dists/stable/main/binary-all/Packages ../../dists/stable/main/binary-amd64/Packages
          cp ../../dists/stable/main/binary-all/Packages ../../dists/stable/main/binary-arm64/Packages
          cd ../..
          
          # Compress Packages files
          for arch in all amd64 arm64; do
            gzip -k -f dists/stable/main/binary-$arch/Packages
          done
      
      - name: Generate Release file
        run: |
          cd dists/stable
          cat > Release << EOF
          Origin: mkv2cast
          Label: mkv2cast
          Suite: stable
          Codename: stable
          Version: 1.0
          Architectures: amd64 arm64 all
          Components: main
          Description: mkv2cast APT repository
          Date: $(date -Ru)
          EOF
          
          # Add checksums
          echo "MD5Sum:" >> Release
          for f in main/binary-*/Packages*; do
            [ -f "$f" ] && echo " $(md5sum $f | cut -d' ' -f1) $(wc -c < $f) $f" >> Release
          done
          
          echo "SHA256:" >> Release
          for f in main/binary-*/Packages*; do
            [ -f "$f" ] && echo " $(sha256sum $f | cut -d' ' -f1) $(wc -c < $f) $f" >> Release
          done
          
          cat Release
      
      - name: Sign Release file
        if: steps.check_gpg.outputs.gpg_configured == 'true'
        env:
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE || '' }}
        run: |
          cd dists/stable
          
          # Check if key is available
          if ! gpg --list-secret-keys --keyid-format LONG | grep -q "sec"; then
            echo "Warning: No GPG key found, skipping signature"
            exit 0
          fi
          
          # Sign Release file (detached signature)
          # Use --yes to automatically trust the key for signing
          if [ -n "$GPG_PASSPHRASE" ]; then
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
              --sign --detach-sign --armor --output Release.gpg Release
            echo "$GPG_PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 \
              --clearsign --output InRelease Release
          else
            gpg --batch --yes --sign --detach-sign --armor --output Release.gpg Release
            gpg --batch --yes --clearsign --output InRelease Release
          fi
          
          echo "Release file signed successfully"
          ls -la Release*
      
      - name: Warning if GPG not configured
        if: steps.check_gpg.outputs.gpg_configured == 'false'
        run: |
          echo "::warning::GPG_PRIVATE_KEY secret is not configured. Repository will be unsigned."
          echo "To enable GPG signing, add GPG_PRIVATE_KEY and GPG_PASSPHRASE to GitHub Secrets."
      
      - name: Create index.html
        run: |
          cat > index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head>
            <title>mkv2cast APT Repository</title>
            <style>
              body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; }
              h1 { color: #333; }
              pre { background: #f4f4f4; padding: 15px; border-radius: 5px; overflow-x: auto; }
              code { background: #f4f4f4; padding: 2px 6px; border-radius: 3px; }
              .note { background: #e7f3ff; border-left: 4px solid #2196F3; padding: 10px 15px; margin: 20px 0; }
            </style>
          </head>
          <body>
            <h1>ðŸŽ¬ mkv2cast APT Repository</h1>
            <p>This is the official APT repository for <a href="https://github.com/voldardard/mkv2cast">mkv2cast</a>.</p>
            
            <h2>Installation</h2>
            <p>Add the repository to your system:</p>
            <pre>
          # Download and add GPG public key (if available)
          if curl -fsSL https://voldardard.github.io/mkv2cast/apt/public-key.gpg > /dev/null 2>&1; then
            curl -fsSL https://voldardard.github.io/mkv2cast/apt/public-key.gpg | sudo gpg --dearmor -o /etc/apt/keyrings/mkv2cast.gpg
            echo "deb [signed-by=/etc/apt/keyrings/mkv2cast.gpg] https://voldardard.github.io/mkv2cast/apt stable main" | sudo tee /etc/apt/sources.list.d/mkv2cast.list
          else
            echo "deb [trusted=yes] https://voldardard.github.io/mkv2cast/apt stable main" | sudo tee /etc/apt/sources.list.d/mkv2cast.list
          fi

          # Update and install
          sudo apt update
          sudo apt install mkv2cast
            </pre>
            
            <div class="note">
              <strong>Note:</strong> This repository supports GPG signing for security. If the public key is available at <a href="public-key.gpg">public-key.gpg</a>, use the signed-by method above. Otherwise, the repository will use trusted=yes mode.
            </div>
            
            <h2>Alternative Installation Methods</h2>
            <ul>
              <li><strong>PyPI:</strong> <code>pip install mkv2cast</code></li>
              <li><strong>AUR (Arch Linux):</strong> <code>yay -S mkv2cast</code></li>
              <li><strong>Manual:</strong> Download .deb from <a href="https://github.com/voldardard/mkv2cast/releases">GitHub Releases</a></li>
            </ul>
            
            <h2>Links</h2>
            <ul>
              <li><a href="https://github.com/voldardard/mkv2cast">GitHub Repository</a></li>
              <li><a href="https://voldardard.github.io/mkv2cast">Documentation</a></li>
              <li><a href="https://pypi.org/project/mkv2cast/">PyPI Package</a></li>
            </ul>
          </body>
          </html>
          EOF
      
      - name: Commit and push to apt-repo branch
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          # Create apt directory structure
          mkdir -p apt
          mv pool apt/ 2>/dev/null || true
          mv dists apt/ 2>/dev/null || true
          mv index.html apt/ 2>/dev/null || true
          
          # Copy public key if it exists (from current step or previous runs)
          if [ -f public-key.gpg ]; then
            cp public-key.gpg apt/ 2>/dev/null || true
          elif [ -f apt/public-key.gpg ]; then
            # Keep existing public key if new one wasn't generated
            echo "Keeping existing public key"
          fi
          
          git add -A
          VERSION_REF="${GITHUB_REF#refs/tags/}"
          if [ -z "$VERSION_REF" ] && [ -n "${{ github.event.release.tag_name || '' }}" ]; then
            VERSION_REF="${{ github.event.release.tag_name }}"
          fi
          git commit -m "Update APT repository for ${VERSION_REF:-manual}" || echo "No changes to commit"
          
          # Configure remote URL with token for authentication
          git remote set-url origin https://x-access-token:${{ secrets.GITHUB_TOKEN }}@github.com/${{ github.repository }}.git
          
          # Push to apt-repo branch
          git push origin apt-repo --force
